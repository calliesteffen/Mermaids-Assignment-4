---
title: "Group Mermaid 206 Assignment 4"
author: "Callie Steffen, Vanessa Guenther, Renee Albrecht"
date: "11/12/2018"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

####Part 1.Describe trends in lobster abundance (counts) and fishing pressure (trap buoys) at the five locations from 2012 - 2017. 

```{r, include=FALSE}
###Loading Necessary Packages
library(tidyverse)
library(effsize)
library(kableExtra)
library(pwr)
library(knitr)
library(plotly)
library(ggplot2)
library(car)
library(onewaytests)
library(readr)
library(dplyr)
library(vcdExtra)
library(kableExtra)
library(xtable)
library(ggsignif)


###Reading in the data sets and renaming for convenience

size_abund<- read.csv("lobster_size_abundance.csv")
traps<-read.csv("lobster_traps.csv")

##Filtering out the transects from data set and only keeping the year not month(keeping year, site, count)
##Basic data wrangling


lobster_abund<- select(size_abund,YEAR,SITE,COUNT) %>% 
  group_by(SITE,YEAR)##Making total counts of lobsters at each site for each year
lobster_abund

traps_site <-select(traps,YEAR,SITE,TRAPS) %>%    ##(keeping year, site, traps)
  filter(SITE=="AQUE"|SITE=="NAPL"|SITE=="MOHK"|SITE=="IVEE"|SITE=="CARP") %>% 
  group_by(SITE,YEAR)
   ##Making total counts of traps at each site for each year

###Exploratory Graphs of the Data Frames

#Histogram for Lobster Abundance

abund_histogram<-ggplot(lobster_abund, aes(x=COUNT)) +
  geom_histogram() 

abund_histogram


###QQ plot for Lobster Abundanance
lobster_qq<-ggplot(lobster_abund, aes(sample =COUNT))+
  geom_qq()
lobster_qq



###QQ Plot for Traps
traps_qq<-ggplot(traps_site, aes(sample=TRAPS)) +
  geom_qq()
traps_qq


##Scatter plots for both lobster and trap numbers using facet wrap for each site

scatter_abundance<-ggplot(lobster_abund, aes(x=YEAR, y=COUNT))+

  geom_point()+
  facet_wrap(~SITE, scale = "free") +
  theme_classic()

scatter_abundance

scatter_traps<-ggplot(traps_site, aes(x=YEAR, y=TRAPS))+
  geom_point(aes(color="COUNT"))+
  facet_wrap(~SITE, scale="free") +

  scale_y_continuous(name="number of lobsters")+
  theme_classic() +
  geom_line()

  scatter_traps


##Combining the data sets so SIte and year are available for both lobster and traps
combined<- left_join(lobster_abund, traps_site, by= c("SITE", "YEAR"))
combined


### Making a summary table and two Line Graps to Compare and Explore if Traps and Lobsters are Associated

summarytable_traps<- summarize(traps_site, sum=sum(TRAPS))

summarytable_traps

summarytable_lobster<-summarize(lobster_abund,sum=sum(COUNT))

summarytable_lobster

###LINE GRAPHS FOR BOTH LOBSTER AND TRAPS AT EACH SITE FOR EACH YEAR

line_traps<-ggplot(summarytable_traps,aes(x=YEAR,y=sum))+
  geom_point()+
  geom_line(aes(col=SITE)) +
  theme_classic() +
  labs(y="TRAP COUNT", title="Total Amount of Lobster Traps Per Site 2012-2017") +
  scale_y_continuous(expand=c(0,0), limits = c(0,1200), breaks = c(0,100,200,300,400,500,600,700,800,900,1000,1100,1200))

line_traps


line_lobster<-ggplot(summarytable_lobster, aes(x=YEAR,y= sum))+
  geom_point()+
  geom_line(aes(col=SITE))+
  theme_classic()+
  labs(y="LOBSTER COUNT",title="Total Abundance of Lobsters Per Site 2012-2017")+
  scale_y_continuous(expand = c(0,0), limits=c(0,750), breaks=c(0,50,100,150,200,250,300,350,400,450,500,550,600,650,700,750))


line_lobster


        
              
             




```
####Part 2. Compare mean lobster sizes (carapace length (mm)) across the five sites for lobster observations collected in 2017.

```{r}
# Create data frame filter for 5 locations and year 2017, select size (remove all -9999 values and turn data into case-format)

compare_ls <- select(size_abund,YEAR,SITE,SIZE,COUNT) %>% 
  filter(YEAR == 2017, 
         SITE=="AQUE"|SITE=="NAPL"|SITE=="MOHK"|SITE=="IVEE"|SITE=="CARP",
         SIZE!= "-99999")
#Remove multiple counts and organize into rows 
ls_comp <- uncount(compare_ls, weights = COUNT, .remove = TRUE, .id = NULL)
#Count in decimal numbers ? 


counts <- with(ls_comp, table(YEAR,SITE,SIZE))
View(counts)
View (ls_comp)

```


```{r}
# Exploratory graphs 

hist_ls <- ggplot(ls_comp, aes(x = SIZE))+
  geom_histogram(bins = 10) +
  facet_wrap(~ SITE, scale = "free")

hist_ls

qq_ls <-ggplot(ls_comp, aes(sample = SIZE)) +
  geom_qq(bins = 10) +
  facet_wrap(~ SITE, scale = "free")

qq_ls

# Groups approx. normally distributed  

box_ls <-  ggplot(ls_comp, aes(x = SITE, y = SIZE)) +
  geom_boxplot(width = .4) +
  geom_jitter(width = 0.1, alpha = 0.5, aes(color = SITE))

box_ls


```

```{r}
#Leven's Test 
variances_ls <- ls_comp %>% 
  group_by(SITE) %>% 
  summarize(
    mean = mean(SIZE),
    sd = sd(SIZE),
    variance = var(SIZE)
  )
View(variances_ls)

# assume equal variance 

levene_ls <- leveneTest(SIZE ~ SITE, data = ls_comp)
levene_ls

#Ho: No difference in variances (Variances are equal)
# Ha: Variances are NOT equal

# There issignificant differences in variances between SITES ? (or use robust SE) 16  Can we still use anova if L-test not affected ? or Welsh ?  

#ANOVA One-Way 
#H0: All means are equall 
#HA: At least two mean are not equal 

ls_anova <- aov(SIZE ~ SITE, data = ls_comp)
ls_sum <- summary(ls_anova)
ls_sum
#At least two means are NOT equal ?

# Which ones ? 
ls_tukey <- TukeyHSD(ls_anova)
ls_tukey


# Table comparing ??

stats_ls <- ls_comp %>% 
  group_by(SITE) %>% 
  summarize(
    mean = round(mean(SIZE),2),
    sd = round(sd(SIZE),2))


figure_ls <- ggplot(stats_ls, aes(x = SITE, y = mean)) +
  geom_col(colour = NA, fill = "gray50", width = 0.5) +
  geom_errorbar(aes(ymax = mean + sd, ymin = mean - sd), width = 0.1)+
   scale_y_continuous(expand = c(0,0), limits = c(0,120))+
    labs(y=expression(Mean~Lobster~Size~~(m)))+
  scale_x_discrete() +
  xlab("\nResearch Sites")+
   geom_signif(comparisons = list(c("NAPL","CARP")), annotations = "p = 0.023", y_position = 95, tip_length = 0.1, size = 0.5, textsize = 3)+
  geom_signif(comparisons = list(c("NAPL","IVEE")), annotations = "p = 0.004", y_position = 110, tip_length = 0.1, size = 0.5, textsize = 3)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),plot.title = element_text(face ="bold"))+
  ggtitle("Lobster Size Distribution at SBC LTER Sites")
  
 
 
figure_ls

```

### Part 3: Comparing changes in lobster size at MPA and non-MPA sites (comparing only 2012 and 2017 sizes)
At Isla Vista and Naples Reef, the two protected MPA sites (with zero fishing pressure), how do lobster sizes
in 2012 and 2017 compare? At the non-MPA sites?


```{r}
#create dataframe to compare lobster size in 2012 and 2017 at MPA and non-MPA sites 

MPA_df <- size_abund %>%
  filter(YEAR == "2012" | YEAR == "2017",  SIZE != "-99999") %>%
  mutate(
    MPA_STATUS = case_when( 
      SITE == "IVEE" ~ "MPA",
      SITE == "NAPL" ~ "MPA",
      SITE == "AQUE" ~ "NON-MPA",
      SITE == "CARP" ~ "NON-MPA",
      SITE == "MOHK" ~ "NON-MPA")) %>%
  select(YEAR, SITE, SIZE, COUNT, MPA_STATUS)

#arrange data so that each lobster has its own row 
MPAdf <- as.data.frame(expand.dft(MPA_df, freq = "COUNT"))
     

View(MPAdf)

#create data summary frame of lobster size median, max, mean, SD, and sample size 

MPA_table <- as.data.frame(expand.dft(size_abund, freq = "COUNT")) %>%
group_by(YEAR) %>% #group data together by same month
  summarize(
    median = round(median(SIZE),2), #find median, round to 2 digits
    max = max(SIZE), #identify maximum 
    mean = round(mean(SIZE),2), #find mean, round to 2 digits 
    stdev = round(sd(SIZE),2), #find SD, round to 2 digits
    length(SIZE)) #find sample size 

View(MPA_table)


```


```{r}


#Create exloratory histograms and qq plots

#histogram to compare 2012 and 2017 lobster sizes 
MPAhist <- ggplot(MPAdf, aes(x = SIZE)) +
  geom_histogram(aes(bins=15, fill = SITE)) +
                   facet_wrap(~YEAR ~MPA_STATUS, scale = "free") +
                   theme_classic()
MPAhist

#qq plot to compare 2012 and 2017 lobster sizes 
MPAqq <- ggplot(MPAdf, aes(sample = SIZE)) +
  geom_qq(aes(color = SITE)) + 
  facet_wrap(~YEAR ~MPA_STATUS, scale = "free") + 
  theme_classic()

MPAqq




```


## Is there a significant difference between lobster size at MPA sites in 2012 and 2017? 

## Is there a significant difference between lobster size at non-MPA sites in 2012 and 2017? 

## Is there a significant difference between lobster size at MPA vs. Non-MPA sites in 2017? 


###PART 4 Proportion Table and Chi-Test

```{r}

chi_prop<-ls_comp %>% 

  
  
prop and chi test



```


